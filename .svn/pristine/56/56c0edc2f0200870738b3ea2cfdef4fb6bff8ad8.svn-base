package org.gecko.framework.system.controller;

import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.Date;

import javax.servlet.http.HttpServletRequest;
import org.springframework.web.servlet.ModelAndView;
import org.gecko.framework.ent.entity.EntEntbasic;
import org.gecko.framework.file.FileUpload;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.multipart.MultipartFile;
/**
 * 企业注册控制器
 * @author Aisino.liuyk
 * @email liuyikun@aisino.com
 * @date 2018年1月5日
 */
@Controller
@RequestMapping("/register")
public class RegisterController {
	/**
	 * 跳转到企业注册的页面
	 * @return
	 */
	@RequestMapping("/registerView")
	public ModelAndView registerView(){
		ModelAndView mad = new ModelAndView("/views/system/login.jsp");
		mad.addObject("registerIframeSrc","/views/register/register1.jsp");
		return mad;
	}
	/**
	 * 企业注册表单提交1
	 * @return
	 */
	@RequestMapping("/registerSubmit1")
	public ModelAndView registerSubmit1(EntEntbasic entBasic){
		String creditcode = entBasic.getCreditcode();
		ModelAndView mad = new ModelAndView("/views/system/register/register2.jsp");
		/**统一社会信用代码后台校验**/
		
		
		mad.addObject("ENT_ENTBASIC",entBasic);
		return mad;
	}
	/**
	 * 上传营业执照
	 * @return
	 */
	@RequestMapping("/uploadInfo")
	public ModelAndView uploadInfo(@RequestParam("uploadFile") MultipartFile uploadFile,HttpServletRequest request,EntEntbasic entBasic){
		ModelAndView mad = new ModelAndView("/views/system/register/register2.jsp");
		/**调用相关方法识别图像并给实体赋值**/
		SimpleDateFormat sdf = new SimpleDateFormat("yyyyMMdd");
		String newFile = sdf.format(new Date());
		String savePath = newFile.concat("/upload/images");
		FileUpload fileUpload = new FileUpload();
		String url = "";
		try {
			url = fileUpload.FileUpload(uploadFile, request, savePath);
		} catch (IOException e) {
			e.printStackTrace();
		}
		/**实体set营业执照的附件地址**/
		entBasic.setLicenseattach(savePath+"/"+url);
		mad.addObject("ENT_ENTBASIC",entBasic);
		mad.addObject("imgUrl",savePath+"/"+url);
		return mad;
	}
	/**
	 * 企业注册表单提交2
	 * @return
	 */
	@RequestMapping("/registerSubmit2")
	public ModelAndView registerSubmit2(@RequestParam("uploadFileProduce") MultipartFile uploadFileProduce,
			@RequestParam("uploadFileBusiness") MultipartFile uploadFileBusiness,@RequestParam("uploadFileSell") MultipartFile uploadFileSell,
			@RequestParam("uploadFileImport") MultipartFile uploadFileImport,HttpServletRequest request,EntEntbasic entBasic){
		ModelAndView mad = new ModelAndView("/views/register/register3.jsp");
		/**许可证上传**/
		SimpleDateFormat sdf = new SimpleDateFormat("yyyyMMdd");
		String newFile = sdf.format(new Date());
		String savePath = newFile.concat("/upload/images");
		FileUpload fileUpload = new FileUpload();
		String producePermissionUrl = "";
		String businessPermissionUrl = "";
		String importPermissionUrl = "";
		String sellPermissionUrl = "";
		try {
			producePermissionUrl = fileUpload.FileUpload(uploadFileProduce, request, savePath);
			businessPermissionUrl= fileUpload.FileUpload(uploadFileBusiness, request, savePath);
			importPermissionUrl = fileUpload.FileUpload(uploadFileImport, request, savePath);
			sellPermissionUrl = fileUpload.FileUpload(uploadFileSell, request, savePath);
		} catch (IOException e) {
			e.printStackTrace();
		}
		
		mad.addObject("ENT_ENTBASIC"/**ENT_ENTBASIC**/);
		return mad;
	}
	/**
	 * 企业注册表单提交3
	 * @return
	 */
	@RequestMapping("/registerSubmit3")
	public ModelAndView registerSubmit3(MultipartFile file,HttpServletRequest request/**ENT_ENTBASIC**/){
		ModelAndView mad = new ModelAndView("/views/register/register4.jsp");
		/**许可证上传**/
		
		String savePath = "/";
		FileUpload fileUpload = new FileUpload();
		try {
			String url = fileUpload.FtpUpload(file, request, savePath);
		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		/**实体set许可证的附件地址**/
		mad.addObject("ENT_ENTBASIC"/**ENT_ENTBASIC**/);
		return mad;
	}
	/**
	 * 企业注册表单提交4
	 * @return
	 */
	@RequestMapping("/registerSubmit4")
	public ModelAndView registerSubmit4(HttpServletRequest request/**ENT_ENTBASIC**/){
		ModelAndView mad = new ModelAndView("/views/register/register5.jsp");
		/**校验联系方式**/
		/**实体set相关信息**/
		mad.addObject("ENT_ENTBASIC"/**ENT_ENTBASIC**/);
		return mad;
	}
	/**
	 * 企业注册表单提交审核
	 * @return
	 */
	@RequestMapping("/registerSubmit")
	public ModelAndView registerSubmit(HttpServletRequest request/**ENT_ENTBASIC**/){
		ModelAndView mad = new ModelAndView("/views/register/success.jsp");
		/**校验实体**/
		/**更新状态为待审核**/
		/**保存实体**/
		mad.addObject("ENT_ENTBASIC"/**ENT_ENTBASIC**/);
		return mad;
	}
}
